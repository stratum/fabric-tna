<!--
Copyright 2020-present Open Networking Foundation
SPDX-License-Identifier: LicenseRef-ONF-Member-Only-1.0
-->
# PTF tests for ONOS fabric-tna.p4

This project contains PTF-based tests for fabric-tna.p4, a P4
designed to work with [Trellis](https://www.opennetworking.org/trellis/),
a set of SDN applications running on top of ONOS to provide the control
plane for an IP fabric based on MPLS segment-routing.

PTF is a framework for data plane testing:
<https://github.com/p4lang/PTF>

This project maintains the test case definition (written in Python), as well as
the scripts to run them on different targets. Test cases are defined inside the
directory `tests/ptf/fabric.ptf` Run scripts can be found in `run/`.

Currently, we provide scripts to test `tofino-model` with `stratum_bf` (`run/tm/`)

To learn more about Stratum:
<https://github.com/stratum/stratum>

## Requirements

All scripts are based on a containerized version of the required tools and can
be executed by installing the following dependencies:

* Docker (tested with v19.03, but it should work with older versions as well)
* make
* Bash-like Unix shell

## Steps to run tests on tofino-model with stratum_bf

Steps are similar to the previous case with a few differences:

* You will need to compile fabric-tna.p4 for Tofino;
* You will need to create or obtain a containerized version of `tofino-model`;
* `stratum_bf` is used to provide a P4Runtime server to control
  `tofino-model` (a Docker image for it will be downloaded automatically.)

The run scripts assume that you have access to a containerized version of the
Intel/Barefoot SDE that includes `tofino-model`. We do not provide such Docker
image, but one can be easily generated by executing the SDE install instructions
inside a Dockerfile.

The run script will use `docker run` to invoke the `tofino-model` command inside
the container. For this reason, the script expects a Docker image that has the
whole Barefoot SDE installed in it or just the `tofino-model` package. In both
cases, the `tofino-model` executable should be on `PATH`.

**IMPORTANT: make sure to reserve at least 8GB of RAM** for your Docker host
system (or VM if running Docker Desktop for Mac), otherwise `tofino-model` might
fail to start or affect test results negatively.

### Steps

1. Clone `fabric-tna` repo and follow instructions to compile fabric.p4 for
   Tofino:

   ```bash
   https://github.com/stratum/fabric-tna.git
   cd fabric-tna
   <open README and follow instructions>
   ```

2. Set the `SDE_DOCKER_IMG` environment variable to the location of a Docker
   image that can be downloaded via `docker pull` and that contains a Barefoot
   SDE installation, including `tofino-model`:

   ```bash
   export SDE_DOCKER_IMG=my-docker-repo/bf-sde:9.0.0
   ```

3. Run PTF tests using the `run/tm/run` script:

    ```bash
    ./run/tm/run <profile> [test-case]
    ```

    **NOTE:** Testing `all` profiles is not supported on this target.

    To run all test cases for the basic `fabric` profile:

    ```bash
    ./run/tm/run fabric
    ```

    To run a specific test case against a specific fabric-tna profile,
    for example `test.FabricBridgingTest` for the `fabric-spgw` profile:

    ```bash
    ./run/tm/run fabric-spgw TEST=test.FabricBridgingTest
    ```

4. If tests fail, check logs in:

   * `run/tm/log` for `tofino-model` and `stratum_bf` logs
   * `tests/ptf/` for PTF-related logs and PCAP traces (`ptf.log` and
     `ptf.pcap`)

## Run tests on other targets

To run tests on targets other than BMv2 (e.g. a real Tofino-based switch), check
the instructions available inside the `tests/ptf` directory.

## Support

For help running the tests please write to the P4 Brigade
mailing list:

<https://groups.google.com/a/onosproject.org/forum/#!forum/brigade-p4>
