<!-- Copyright 2020-present Open Networking Foundation -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
# PTF tests for fabric-tna

PTF is a framework for data plane testing:
<https://github.com/p4lang/PTF>

This directory maintains the test case definitions (written in Python), as well
as scripts to run them on different targets. Test cases can be found insed the
directory `tests/ptf/fabric.ptf`. Run scripts can be found in `run/`.

Currently, we provide scripts to run PTF tests against two targets:
* Stratum running on top of tofino-model
* dummy target used to generate Stratum TestVectors

## Steps to run tests on tofino-model with Stratum

The run scripts assume that you have access to a containerized version of the
Intel Barefoot SDE that includes tofino-model. We do not provide such Docker
image, but one can be easily generated by executing the SDE install instructions
inside a `Dockerfile`.

The run script will use `docker run` to invoke the tofino-model command inside
the container. For this reason, the script expects a Docker image that has the
whole Barefoot SDE installed in it or just the tofino-model package. In both
cases, the tofino-model executable should be on `PATH`.

A Docker image for Stratum will be automatically downloaded when executing tests
for the first time.

**IMPORTANT: make sure to reserve at least 8GB of RAM** for your Docker host
system (or VM if running Docker Desktop for Mac), otherwise tofino-model might
fail to start or affect test results negatively.

### Steps

1. Build `fabric-tna` using instruction in the top-level README.

2. Set the `SDE_DOCKER_IMG` environment variable to the location of a Docker
   image that includes tofino-model:

   ```bash
    export SDE_DOCKER_IMG=my-docker-repo/bf-sde:9.5.0
    ```

3. Run PTF tests using the `run/tm/run` script:

    ```bash
    ./run/tm/run <profile> [test-case]
    ```

    To run all test cases for the basic `fabric` profile:

    ```bash
    ./run/tm/run fabric
    ```

    To run a specific test case against a specific profile,
    for example `test.FabricBridgingTest` for the `fabric-spgw` profile:

    ```bash
    ./run/tm/run fabric-spgw TEST=test.FabricBridgingTest
    ```

4. If tests fail, check logs in:

   * `run/tm/log` for tofino-model and Stratum logs
   * `tests/ptf/` for PTF-related logs and PCAP traces (`ptf.log` and
     `ptf.pcap`)

### Testing against custom Stratum builds

If you want to try a new Stratum build, but don't want to wait to build a new
Docker image for it, set the following env variable before running the PTF
tests.

```bash
export STRATUM_DOCKER_FLAG="-v /path/to/my/stratum_bfrt:/usr/bin/stratum_bfrt"
```

## Migrating to Stratum Test Vectors

We are currently in the process of migrating the test runner framework from PTF
to Stratum's [testvectors-runner].

For this reason, some PTF-based test case definitions are instrumented
to generate protobuf-based [TestVectors] (TVs) (under `tests/ptf/testvectors`).
The long-term goal is to remove all PTF references from the codebase, but
continue using Python as a convenient way to generate TVs. For now, we use a
Python library (`tvutils`) to wrap PTF and P4Runtime calls in methods that
generate TV's actions, stimuli and expectations instead of calling the
corresponding PTF or P4Runtime gRPC methods.

### Steps to generate TestVectors

The instructions to generate TVs are similar to running PTF tests on tofino-model.

1. Build `fabric-tna` using instruction in the top-level README.

2. Generate TestVectors using the `run/tv/run` script:

    ```bash
    ./run/tv/run <profile> [device] [portmap] [grpcaddr] [cpuport] [test-case]
    ```
   Default values for optional arguments are:
   1. `device`: `tofino`
   2. `portmap`: `portmap.veth.json`
   3. `grpcaddr`: `127.0.0.1:28000`
   4. `cpuport`: `320`

   Example command with all the optional arguments set:

   ```bash
   ./run/tv/run fabric DEVICE=tofino PORTMAP=port_map.hw.json GRPCADDR=10.128.13.111:28000 CPUPORT=320 TEST=test.FabricBridgingTest
   ```

    To generate TestVectors for the basic `fabric` profile:

    ```bash
    ./run/tv/run fabric
    ```

    To generate a specific test case for a specific fabric profile,
    for example `test.FabricBridgingTest` for the `fabric-spgw` profile:

    ```bash
    ./run/tv/run fabric-spgw TEST=test.FabricBridgingTest
    ```

[testvectors-runner]: https://github.com/stratum/testvectors-runner
[TestVectors]: https://github.com/stratum/testvectors
